<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Studio: Color Edition</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #ffffff; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* OsciloscÃ³pio */
        #top-viz { height: 70px; background: #000; border-bottom: 2px solid #333; }
        canvas { width: 100%; height: 100%; }

        /* Status */
        .header-info { background: #000; padding: 5px 15px; display: flex; justify-content: space-between; font-size: 11px; color: #888; border-bottom: 1px solid #222; }

        /* Sequenciador */
        #studio { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .track { background: var(--panel); border-radius: 12px; padding: 12px; border-left: 6px solid #444; transition: 0.2s; }
        
        /* Cores das Trilhas (Baseado na sua imagem) */
        .track-a { border-left-color: #00ff00; } /* Verde */
        .track-b { border-left-color: #00d2ff; } /* Azul */
        .track-c { border-left-color: #ff00ff; } /* Rosa */
        .track-d { border-left-color: #ffcc00; } /* Amarelo */

        .active-edit { background: #252525; box-shadow: inset 0 0 10px rgba(255,255,255,0.05); }

        .controls { display: grid; grid-template-columns: 40px 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 10px; }
        .slider-box { display: flex; flex-direction: column; font-size: 9px; color: #aaa; }
        input[type="range"] { accent-color: white; height: 4px; }

        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
        .step { 
            height: 40px; background: #333; border-radius: 8px; border: none;
            color: rgba(255,255,255,0.2); font-size: 10px; font-weight: bold;
        }

        /* Cores Ativas dinÃ¢micas via JS */
        .step.playing { border: 2px solid white; transform: scale(1.05); }

        /* Footer */
        footer { background: #000; padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid #333; }
        .btn { padding: 14px; border: none; border-radius: 10px; font-weight: bold; text-transform: uppercase; font-size: 11px; cursor: pointer; }
        .btn-play { background: #00ff00; color: #000; }
        .btn-save { background: #00d2ff; color: #000; }
        .btn-rec { background: #ff4444; color: #fff; grid-column: span 2; font-size: 13px; }
    </style>
</head>
<body>

<div id="top-viz"><canvas id="canvas"></canvas></div>

<div class="header-info">
    <span>PROJETO: MEU_BEAT_V1</span>
    <span id="active-name">TRILHA A</span>
    <span onclick="location.reload()" style="color:#ff4444">LIMPAR TUDO</span>
</div>

<div id="studio"></div>

<footer>
    <button id="recBtn" class="btn btn-rec">ðŸŽ¤ GRAVAR NA TRILHA ATIVA</button>
    <button class="btn btn-play" onclick="togglePlay()">â–¶ PLAY / STOP</button>
    <button class="btn btn-save" onclick="exportAudio()">ðŸ’¾ BAIXAR RITMO</button>
</footer>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    const masterGain = audioCtx.createGain();
    const dest = audioCtx.createMediaStreamDestination();

    analyser.fftSize = 512;
    masterGain.connect(analyser);
    analyser.connect(audioCtx.destination);
    masterGain.connect(dest);

    let isPlaying = false;
    let currentStep = 0;
    let nextStepTime = 0;
    let activeTrackIdx = 0;

    const trackColors = ['#00ff00', '#00d2ff', '#ff00ff', '#ffcc00'];
    const trackClasses = ['track-a', 'track-b', 'track-c', 'track-d'];

    let tracks = JSON.parse(localStorage.getItem('gemini_final_data')) || [
        { id: 'A', steps: new Array(16).fill(false), vol: 0.8, eco: 0 },
        { id: 'B', steps: new Array(16).fill(false), vol: 0.8, eco: 0 },
        { id: 'C', steps: new Array(16).fill(false), vol: 0.8, eco: 0 },
        { id: 'D', steps: new Array(16).fill(false), vol: 0.8, eco: 0 }
    ];

    let audioBuffers = [null, null, null, null];

    function render() {
        const studio = document.getElementById('studio');
        studio.innerHTML = '';
        tracks.forEach((tr, i) => {
            const card = document.createElement('div');
            card.className = `track ${trackClasses[i]} ${activeTrackIdx === i ? 'active-edit' : ''}`;
            card.onclick = () => { 
                activeTrackIdx = i; 
                document.getElementById('active-name').innerText = "EDITANDO: TRILHA " + tr.id;
                render(); 
            };
            
            card.innerHTML = `
                <div class="controls">
                    <b style="color:${trackColors[i]}">${tr.id}</b>
                    <div class="slider-box">VOL <input type="range" min="0" max="1" step="0.1" value="${tr.vol}" oninput="tracks[${i}].vol=this.value; save()"></div>
                    <div class="slider-box">ECO <input type="range" min="0" max="0.8" step="0.1" value="${tr.eco}" oninput="tracks[${i}].eco=this.value; save()"></div>
                </div>
                <div class="grid">
                    ${tr.steps.map((s, si) => {
                        const isCurrent = currentStep === si && isPlaying;
                        const color = s ? trackColors[i] : '#333';
                        const textColor = s ? '#000' : 'rgba(255,255,255,0.2)';
                        return `<button class="step ${isCurrent ? 'playing' : ''}" 
                                 style="background:${color}; color:${textColor}; box-shadow: ${s ? '0 0 10px '+trackColors[i] : 'none'}"
                                 onclick="event.stopPropagation(); toggleStep(${i}, ${si})">${si + 1}</button>`;
                    }).join('')}
                </div>
            `;
            studio.appendChild(card);
        });
    }

    function toggleStep(t, s) { tracks[t].steps[s] = !tracks[t].steps[s]; save(); render(); }
    function save() { localStorage.setItem('gemini_final_data', JSON.stringify(tracks)); }

    function playSound(buffer, trData, time) {
        if (!buffer) return;
        const src = audioCtx.createBufferSource();
        const g = audioCtx.createGain();
        const delay = audioCtx.createDelay();
        const feedback = audioCtx.createGain();

        src.buffer = buffer;
        g.gain.value = trData.vol;
        delay.delayTime.value = 0.25;
        feedback.gain.value = trData.eco;

        src.connect(g);
        g.connect(masterGain);
        g.connect(delay);
        delay.connect(feedback);
        feedback.connect(delay);
        delay.connect(masterGain);
        src.start(time);
    }

    function scheduler() {
        while (nextStepTime < audioCtx.currentTime + 0.1) {
            tracks.forEach((tr, i) => {
                if (tr.steps[currentStep]) playSound(audioBuffers[i], tr, nextStepTime);
            });
            nextStepTime += (60.0 / 120.0 / 4);
            currentStep = (currentStep + 1) % 16;
            render();
        }
        if (isPlaying) requestAnimationFrame(scheduler);
    }

    function togglePlay() {
        isPlaying = !isPlaying;
        if (isPlaying) { audioCtx.resume(); currentStep = 0; nextStepTime = audioCtx.currentTime; scheduler(); }
    }

    let recorder;
    document.getElementById('recBtn').onclick = async () => {
        if (recorder?.state === "recording") { recorder.stop(); return; }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/ogg' });
            const arrayBuffer = await blob.arrayBuffer();
            audioCtx.decodeAudioData(arrayBuffer, b => {
                audioBuffers[activeTrackIdx] = b;
                alert("Som salvo na Trilha " + tracks[activeTrackIdx].id);
                render();
            });
            document.getElementById('recBtn').innerText = "ðŸŽ¤ GRAVAR NA TRILHA ATIVA";
        };
        recorder.start();
        document.getElementById('recBtn').innerText = "â¹ PARAR (GRAVANDO...)";
    };

    function exportAudio() {
        alert("Gravando os prÃ³ximos 8 segundos...");
        const mr = new MediaRecorder(dest.stream);
        const chunks = [];
        mr.ondataavailable = e => chunks.push(e.data);
        mr.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'meu_hit.webm'; a.click();
        };
        mr.start();
        setTimeout(() => mr.stop(), 8000);
    }

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    function draw() {
        requestAnimationFrame(draw);
        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteTimeDomainData(data);
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.strokeStyle = trackColors[activeTrackIdx]; ctx.lineWidth = 3; ctx.beginPath();
        let x = 0;
        for(let i=0; i<data.length; i++) {
            let v = data[i]/128.0; let y = v * canvas.height/2;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            x += canvas.width/data.length;
        }
        ctx.stroke();
    }

    canvas.width = window.innerWidth;
    render(); draw();
</script>
</body>
</html>

