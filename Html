<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Step Sequencer</title>
    <style>
        :root { --neon: #00ff00; --bg: #0d0d0d; --panel: #1a1a1a; --dark: #000; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }

        /* Topo com Oscilosc√≥pio */
        #top-bar { height: 80px; background: var(--dark); border-bottom: 2px solid var(--neon); position: relative; }
        canvas { width: 100%; height: 100%; }

        /* Configura√ß√µes (Tempo/Passos) */
        #config-bar { background: var(--panel); padding: 10px; display: flex; gap: 20px; font-size: 12px; border-bottom: 1px solid #333; justify-content: center; }
        input[type="number"] { background: #000; border: 1px solid var(--neon); color: var(--neon); width: 50px; text-align: center; }

        /* Sequenciador */
        #sequencer { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .track { display: flex; align-items: center; gap: 10px; background: #111; padding: 5px; border-radius: 5px; }
        .track-info { width: 80px; font-size: 10px; font-weight: bold; color: var(--neon); }
        .steps-container { display: flex; gap: 4px; flex: 1; overflow-x: auto; padding: 5px; }
        .step { 
            width: 40px; height: 50px; background: #333; border-radius: 4px; border: 1px solid #444;
            display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer;
        }
        .step.active { background: var(--neon); color: black; box-shadow: 0 0 10px var(--neon); }
        .step.playing { border: 2px solid white; }

        /* Painel Inferior */
        #controls { background: var(--dark); padding: 15px; border-top: 2px solid #333; display: flex; flex-direction: column; gap: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 12px; }
        .btn-play { background: var(--neon); color: black; }
        .btn-rec { background: #ff4444; color: white; }
        
        #keyboard { display: flex; height: 60px; gap: 2px; overflow-x: auto; }
        .key { min-width: 40px; background: white; border-radius: 0 0 4px 4px; color: black; font-size: 9px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; }
    </style>
</head>
<body>

<div id="top-bar">
    <canvas id="osc"></canvas>
</div>

<div id="config-bar">
    <div>TEMPO: <input type="number" id="bpm" value="120"> BPM</div>
    <div>PASSOS: <span id="step-count">16</span></div>
</div>

<div id="sequencer">
    </div>

<div id="controls">
    <div class="btn-group">
        <button class="btn btn-play" onclick="togglePlay()">‚ñ∂ PLAY / STOP</button>
        <button id="recBtn" class="btn btn-rec">üé§ GRAVAR PARA TRILHA</button>
    </div>
    <div id="keyboard"></div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    
    let tracks = [
        { name: 'TRILHA A', buffer: null, steps: new Array(16).fill(false) },
        { name: 'TRILHA B', buffer: null, steps: new Array(16).fill(false) },
        { name: 'TRILHA C', buffer: null, steps: new Array(16).fill(false) },
        { name: 'TRILHA D', buffer: null, steps: new Array(16).fill(false) }
    ];

    let isPlaying = false;
    let currentStep = 0;
    let nextStepTime = 0;
    let selectedTrackIndex = 0;

    // --- INICIALIZAR INTERFACE ---
    const sequencerEl = document.getElementById('sequencer');
    function renderSequencer() {
        sequencerEl.innerHTML = '';
        tracks.forEach((track, tIdx) => {
            const trEl = document.createElement('div');
            trEl.className = `track ${selectedTrackIndex === tIdx ? 'selected' : ''}`;
            trEl.onclick = () => { selectedTrackIndex = tIdx; renderSequencer(); };

            const info = document.createElement('div');
            info.className = 'track-info';
            info.innerText = track.name + (track.buffer ? ' ‚úÖ' : ' ‚è≥');

            const stepsContainer = document.createElement('div');
            stepsContainer.className = 'steps-container';

            track.steps.forEach((stepActive, sIdx) => {
                const sEl = document.createElement('div');
                sEl.className = `step ${stepActive ? 'active' : ''}`;
                sEl.innerText = sIdx + 1;
                sEl.onclick = (e) => {
                    e.stopPropagation();
                    track.steps[sIdx] = !track.steps[sIdx];
                    renderSequencer();
                    uiSound();
                };
                stepsContainer.appendChild(sEl);
            });

            trEl.appendChild(info);
            trEl.appendChild(stepsContainer);
            sequencerEl.appendChild(trEl);
        });
    }

    // --- L√ìGICA DE √ÅUDIO ---
    function playSound(buffer, time) {
        if (!buffer) return;
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        source.start(time);
    }

    function scheduler() {
        while (nextStepTime < audioCtx.currentTime + 0.1) {
            tracks.forEach(track => {
                if (track.steps[currentStep]) {
                    playSound(track.buffer, nextStepTime);
                }
            });
            advanceStep();
        }
        if (isPlaying) requestAnimationFrame(scheduler);
    }

    function advanceStep() {
        const bpm = document.getElementById('bpm').value;
        const secondsPerStep = 60.0 / bpm / 4; // 16 avos
        nextStepTime += secondsPerStep;
        
        currentStep++;
        if (currentStep >= 16) currentStep = 0;
        
        // Visual highlight
        document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
        const allTracks = document.querySelectorAll('.track');
        allTracks.forEach(tr => {
            const steps = tr.querySelectorAll('.step');
            if(steps[currentStep]) steps[currentStep].classList.add('playing');
        });
    }

    function togglePlay() {
        isPlaying = !isPlaying;
        if (isPlaying) {
            audioCtx.resume();
            currentStep = 0;
            nextStepTime = audioCtx.currentTime;
            scheduler();
        }
    }

    // --- GRAVA√á√ÉO ---
    let recorder;
    document.getElementById('recBtn').onclick = async () => {
        if (recorder?.state === "recording") {
            recorder.stop();
            return;
        }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/ogg' });
            const arrayBuffer = await blob.arrayBuffer();
            audioCtx.decodeAudioData(arrayBuffer, b => {
                tracks[selectedTrackIndex].buffer = b;
                renderSequencer();
            });
            document.getElementById('recBtn').innerText = "üé§ GRAVAR PARA " + tracks[selectedTrackIndex].name;
        };
        recorder.start();
        document.getElementById('recBtn').innerText = "‚èπ PARANDO...";
    };

    // --- VISUALIZADOR ---
    const canvas = document.getElementById('osc');
    const ctx = canvas.getContext('2d');
    function draw() {
        requestAnimationFrame(draw);
        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteTimeDomainData(data);
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.strokeStyle = '#00ff00';
        ctx.beginPath();
        let x = 0;
        for(let i=0; i<data.length; i++) {
            let v = data[i]/128.0;
            let y = v * canvas.height/2;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            x += canvas.width/data.length;
        }
        ctx.stroke();
    }

    function uiSound() {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.value = 1000;
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.1);
    }

    // --- SETUP INICIAL ---
    canvas.width = window.innerWidth;
    renderSequencer();
    draw();

    // Teclado r√°pido para teste
    const kb = document.getElementById('keyboard');
    for(let i=0; i<12; i++) {
        const k = document.createElement('div');
        k.className = 'key';
        k.innerText = 'T'+i;
        k.onclick = () => playSound(tracks[selectedTrackIndex].buffer, audioCtx.currentTime);
        kb.appendChild(k);
    }
</script>
</body>
</html>
